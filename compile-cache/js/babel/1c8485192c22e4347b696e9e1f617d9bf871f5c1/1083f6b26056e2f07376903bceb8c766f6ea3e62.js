var __vue_template__ = "<ol class=\"full-menu list-tree has-collapsable-children\" tabindex=\"-1\" v-on=\"mouseenter: hover, mouseleave: unhover\">\n    <div v-class=\"hidden: !isHovered\" class=\"save icon icon-bookmark\" v-on=\"click: save\">\n    </div>\n      <folder v-repeat=\"entry: filesTree\" track-by=\"path\">\n      </folder>\n    </ol>";
var addFileToTree, addFolderToTree, getElementFromTree, projectManager, sep, settings, sortByName, treeManager, wherePath;

wherePath = function (array, path) {
  var j, len, obj;
  for (j = 0, len = array.length; j < len; j++) {
    obj = array[j];
    if (obj.path === path) {
      return obj;
    }
  }
  return null;
};

sortByName = function (array) {
  return array.sort(function (a, b) {
    if (a.name < b.name) {
      return -1;
    }
    if (a.name > b.name) {
      return 1;
    }
    return 0;
  });
};

sep = null;

projectManager = null;

settings = null;

treeManager = null;

getElementFromTree = function (tree, path, sort, createElement) {
  var element;
  element = wherePath(tree, path);
  if (createElement != null) {
    if (element == null) {
      element = createElement();
      tree.push(element);
      if (sort) {
        sortByName(tree);
      }
    }
  }
  return [element, tree];
};

addFileToTree = function (tree, path, name) {
  var element, pathIdentifier, projectPaths, ref, result, sort, splittedPath;
  pathIdentifier = "";
  sort = true;
  if (name == null) {
    sort = false;
    result = atom.project.relativizePath(path);
    splittedPath = result[1].split(sep);
    name = splittedPath.pop();
    if (result[0] != null) {
      projectPaths = atom.project.getPaths();
      if (projectPaths.length > 1) {
        pathIdentifier += "" + (projectPaths.indexOf(result[0]) + 1);
        if (splittedPath.length > 0) {
          pathIdentifier += sep;
        }
      }
    }
    pathIdentifier += splittedPath.join(sep);
  }
  ref = getElementFromTree(tree, path, sort, function () {
    return {
      name: name,
      path: path,
      pathIdentifier: pathIdentifier
    };
  }), element = ref[0], tree = ref[1];
  return tree;
};

addFolderToTree = function (tree, splittedPath, index, path) {
  var calculatedPath, element, ref;
  calculatedPath = splittedPath.slice(0, index + 1).join("/");
  ref = getElementFromTree(tree, calculatedPath, true, function () {
    return {
      name: splittedPath[index],
      folders: [],
      files: [],
      path: calculatedPath
    };
  }), element = ref[0], tree = ref[1];
  if (splittedPath.length === index + 2) {
    element.files = addFileToTree(element.files, path, splittedPath[index + 1]);
  } else {
    element.folders = addFolderToTree(element.folders, splittedPath, index + 1, path);
  }
  return tree;
};

module.exports = {
  data: function data() {
    return {
      filesTree: [],
      colors: {},
      expanded: false,
      saving: false,
      savedSettings: [],
      isHovered: false
    };
  },
  methods: {
    hover: function hover(e) {
      return this.isHovered = true;
    },
    unhover: function unhover(e) {
      return this.isHovered = false;
    },
    addFile: function addFile(path) {
      var result, rootElement, rootName, splittedPath;
      this.log("adding " + path, 2);
      if (atom.config.get("opened-files.asList")) {
        rootElement = this.filesTree[0];
        if (rootElement == null) {
          rootElement = {
            name: "Opened files",
            path: "",
            folders: [],
            files: [],
            isRoot: true
          };
          this.filesTree.push(rootElement);
        }
        return rootElement.files = addFileToTree(rootElement.files, path);
      } else {
        result = atom.project.relativizePath(path);
        if ((result != null ? result[0] : void 0) != null) {
          rootName = result[0].split(sep).pop();
          rootElement = wherePath(this.filesTree, result[0]);
          if (rootElement == null) {
            rootElement = {
              name: rootName,
              path: result[0],
              folders: [],
              files: []
            };
            this.filesTree.push(rootElement);
            sortByName(this.filesTree);
          }
          splittedPath = result[1].split(sep);
          if (splittedPath.length === 1) {
            return rootElement.files = addFileToTree(rootElement.files, path, splittedPath[0]);
          } else {
            return rootElement.folders = addFolderToTree(rootElement.folders, splittedPath, 0, path);
          }
        }
      }
    },
    selected: function selected(path) {
      return this.$broadcast("selected", path);
    },
    resize: function resize() {
      return treeManager.autoHeight();
    },
    colorChangeCb: function colorChangeCb(path, color) {
      if (typeof this !== "undefined" && this !== null && this.colors != null) {
        this.log("colorChangeCb called", 2);
        this.colors[path] = color;
        return this.$broadcast("color", path);
      }
    },
    redraw: function redraw() {
      var j, len, path, results;
      this.filesTree = [];
      results = [];
      for (j = 0, len = settings.length; j < len; j++) {
        path = settings[j];
        results.push(this.addFile(path));
      }
      return results;
    },
    removePath: function removePath(path) {
      var i;
      i = settings.indexOf(path);
      if (i > -1) {
        return settings.splice(i, 1);
      }
    },
    save: function save() {
      if (this.saving === false) {
        this.saving = true;
        this.log("saving", 2);
        projectManager.addToProjectSetting(settings);
        this.savedSettings = settings.slice();
        return this.saving = false;
      } else {
        this.log("delaying save", 2);
        setTimeout((function (_this) {
          return function () {
            return _this.saving = false;
          };
        })(this), 90);
        return setTimeout(this.save, 100);
      }
    },
    closeUnsaved: function closeUnsaved() {
      var j, len, path, results;
      results = [];
      for (j = 0, len = settings.length; j < len; j++) {
        path = settings[j];
        if (this.savedSettings.indexOf(path) === -1) {
          results.push(this.$broadcast("close", path));
        } else {
          results.push(void 0);
        }
      }
      return results;
    }
  },
  beforeCompile: function beforeCompile() {
    sep = require("path").sep;
    if (projectManager == null) {
      projectManager = require("./../lib/project-manager");
    }
    if (treeManager == null) {
      treeManager = require("./../lib/tree-manager");
    }
    settings = projectManager.getProjectSetting();
    if (!Array.isArray(settings)) {
      settings = [];
    }
    this.savedSettings = settings.slice();
    return this.log("beforeCompile", 2);
  },
  created: function created() {
    return this.$on("removeFolder", (function (_this) {
      return function (entry) {
        _this.filesTree.$remove(entry);
        return false;
      };
    })(this));
  },
  compiled: function compiled() {
    var j, len, path;
    for (j = 0, len = settings.length; j < len; j++) {
      path = settings[j];
      this.addFile(path);
    }
    this.addDisposable(atom.workspace.observeTextEditors((function (_this) {
      return function (editor) {
        if ((editor != null ? editor.getPath : void 0) != null) {
          path = editor.getPath();
          if (path != null && settings.indexOf(path) === -1) {
            _this.addFile(path);
            return settings.push(path);
          }
        }
      };
    })(this)));
    this.addDisposable(atom.commands.add("atom-workspace", {
      "opened-files:close-all-but-saved": this.closeUnsaved
    }));
    this.addDisposable(atom.config.onDidChange("opened-files.asList", this.redraw));
    this.addDisposable(atom.config.onDidChange("opened-files.highlightOnHover", this.redraw));
    this.addDisposable(atom.config.onDidChange("opened-files.debug", this.redraw));
    return this.log("compiled", 2);
  },
  ready: function ready() {
    return this.log("ready", 2);
  },
  attached: function attached() {
    return this.log("attached", 2);
  }
};

;(typeof module.exports === "function" ? module.exports.options : module.exports).template = __vue_template__;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2Npbl9jaGFsaWMvLmF0b20vcGFja2FnZXMvb3BlbmVkLWZpbGVzL2NvbXBvbmVudHNfY29tcGlsZWQvYXBwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksZ0JBQWdCLEdBQUcsc1VBQXNVLENBQUM7QUFDOVYsSUFBSSxhQUFhLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxDQUFDOztBQUUxSCxTQUFTLEdBQUcsVUFBUyxLQUFLLEVBQUUsSUFBSSxFQUFFO0FBQ2hDLE1BQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7QUFDaEIsT0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDNUMsT0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNmLFFBQUksR0FBRyxDQUFDLElBQUksS0FBSyxJQUFJLEVBQUU7QUFDckIsYUFBTyxHQUFHLENBQUM7S0FDWjtHQUNGO0FBQ0QsU0FBTyxJQUFJLENBQUM7Q0FDYixDQUFDOztBQUVGLFVBQVUsR0FBRyxVQUFTLEtBQUssRUFBRTtBQUMzQixTQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQy9CLFFBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFO0FBQ25CLGFBQU8sQ0FBQyxDQUFDLENBQUM7S0FDWDtBQUNELFFBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFO0FBQ25CLGFBQU8sQ0FBQyxDQUFDO0tBQ1Y7QUFDRCxXQUFPLENBQUMsQ0FBQztHQUNWLENBQUMsQ0FBQztDQUNKLENBQUM7O0FBRUYsR0FBRyxHQUFHLElBQUksQ0FBQzs7QUFF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aEIsV0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztHQUM3QjtBQUNELFVBQVEsRUFBRSxvQkFBVztBQUNuQixXQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO0dBQ2hDO0NBQ0YsQ0FBQzs7QUFFRixDQUFDLENBQUMsT0FBTyxNQUFNLENBQUMsT0FBTyxLQUFLLFVBQVUsR0FBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sR0FBRSxNQUFNLENBQUMsT0FBTyxDQUFBLENBQUUsUUFBUSxHQUFHLGdCQUFnQixDQUFDIiwiZmlsZSI6Ii9ob21lL2Npbl9jaGFsaWMvLmF0b20vcGFja2FnZXMvb3BlbmVkLWZpbGVzL2NvbXBvbmVudHNfY29tcGlsZWQvYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fdnVlX3RlbXBsYXRlX18gPSBcIjxvbCBjbGFzcz1cXFwiZnVsbC1tZW51IGxpc3QtdHJlZSBoYXMtY29sbGFwc2FibGUtY2hpbGRyZW5cXFwiIHRhYmluZGV4PVxcXCItMVxcXCIgdi1vbj1cXFwibW91c2VlbnRlcjogaG92ZXIsIG1vdXNlbGVhdmU6IHVuaG92ZXJcXFwiPlxcbiAgICA8ZGl2IHYtY2xhc3M9XFxcImhpZGRlbjogIWlzSG92ZXJlZFxcXCIgY2xhc3M9XFxcInNhdmUgaWNvbiBpY29uLWJvb2ttYXJrXFxcIiB2LW9uPVxcXCJjbGljazogc2F2ZVxcXCI+XFxuICAgIDwvZGl2PlxcbiAgICAgIDxmb2xkZXIgdi1yZXBlYXQ9XFxcImVudHJ5OiBmaWxlc1RyZWVcXFwiIHRyYWNrLWJ5PVxcXCJwYXRoXFxcIj5cXG4gICAgICA8L2ZvbGRlcj5cXG4gICAgPC9vbD5cIjtcbnZhciBhZGRGaWxlVG9UcmVlLCBhZGRGb2xkZXJUb1RyZWUsIGdldEVsZW1lbnRGcm9tVHJlZSwgcHJvamVjdE1hbmFnZXIsIHNlcCwgc2V0dGluZ3MsIHNvcnRCeU5hbWUsIHRyZWVNYW5hZ2VyLCB3aGVyZVBhdGg7XG5cbndoZXJlUGF0aCA9IGZ1bmN0aW9uKGFycmF5LCBwYXRoKSB7XG4gIHZhciBqLCBsZW4sIG9iajtcbiAgZm9yIChqID0gMCwgbGVuID0gYXJyYXkubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHtcbiAgICBvYmogPSBhcnJheVtqXTtcbiAgICBpZiAob2JqLnBhdGggPT09IHBhdGgpIHtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufTtcblxuc29ydEJ5TmFtZSA9IGZ1bmN0aW9uKGFycmF5KSB7XG4gIHJldHVybiBhcnJheS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtcbiAgICBpZiAoYS5uYW1lIDwgYi5uYW1lKSB7XG4gICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIGlmIChhLm5hbWUgPiBiLm5hbWUpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gMDtcbiAgfSk7XG59O1xuXG5zZXAgPSBudWxsO1xuXG5wcm9qZWN0TWFuYWdlciA9IG51bGw7XG5cbnNldHRpbmdzID0gbnVsbDtcblxudHJlZU1hbmFnZXIgPSBudWxsO1xuXG5nZXRFbGVtZW50RnJvbVRyZWUgPSBmdW5jdGlvbih0cmVlLCBwYXRoLCBzb3J0LCBjcmVhdGVFbGVtZW50KSB7XG4gIHZhciBlbGVtZW50O1xuICBlbGVtZW50ID0gd2hlcmVQYXRoKHRyZWUsIHBhdGgpO1xuICBpZiAoY3JlYXRlRWxlbWVudCAhPSBudWxsKSB7XG4gICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkge1xuICAgICAgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQoKTtcbiAgICAgIHRyZWUucHVzaChlbGVtZW50KTtcbiAgICAgIGlmIChzb3J0KSB7XG4gICAgICAgIHNvcnRCeU5hbWUodHJlZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBbZWxlbWVudCwgdHJlZV07XG59O1xuXG5hZGRGaWxlVG9UcmVlID0gZnVuY3Rpb24odHJlZSwgcGF0aCwgbmFtZSkge1xuICB2YXIgZWxlbWVudCwgcGF0aElkZW50aWZpZXIsIHByb2plY3RQYXRocywgcmVmLCByZXN1bHQsIHNvcnQsIHNwbGl0dGVkUGF0aDtcbiAgcGF0aElkZW50aWZpZXIgPSBcIlwiO1xuICBzb3J0ID0gdHJ1ZTtcbiAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgIHNvcnQgPSBmYWxzZTtcbiAgICByZXN1bHQgPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgocGF0aCk7XG4gICAgc3BsaXR0ZWRQYXRoID0gcmVzdWx0WzFdLnNwbGl0KHNlcCk7XG4gICAgbmFtZSA9IHNwbGl0dGVkUGF0aC5wb3AoKTtcbiAgICBpZiAocmVzdWx0WzBdICE9IG51bGwpIHtcbiAgICAgIHByb2plY3RQYXRocyA9IGF0b20ucHJvamVjdC5nZXRQYXRocygpO1xuICAgICAgaWYgKHByb2plY3RQYXRocy5sZW5ndGggPiAxKSB7XG4gICAgICAgIHBhdGhJZGVudGlmaWVyICs9IFwiXCIgKyAocHJvamVjdFBhdGhzLmluZGV4T2YocmVzdWx0WzBdKSArIDEpO1xuICAgICAgICBpZiAoc3BsaXR0ZWRQYXRoLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBwYXRoSWRlbnRpZmllciArPSBzZXA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcGF0aElkZW50aWZpZXIgKz0gc3BsaXR0ZWRQYXRoLmpvaW4oc2VwKTtcbiAgfVxuICByZWYgPSBnZXRFbGVtZW50RnJvbVRyZWUodHJlZSwgcGF0aCwgc29ydCwgZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBwYXRoOiBwYXRoLFxuICAgICAgcGF0aElkZW50aWZpZXI6IHBhdGhJZGVudGlmaWVyXG4gICAgfTtcbiAgfSksIGVsZW1lbnQgPSByZWZbMF0sIHRyZWUgPSByZWZbMV07XG4gIHJldHVybiB0cmVlO1xufTtcblxuYWRkRm9sZGVyVG9UcmVlID0gZnVuY3Rpb24odHJlZSwgc3BsaXR0ZWRQYXRoLCBpbmRleCwgcGF0aCkge1xuICB2YXIgY2FsY3VsYXRlZFBhdGgsIGVsZW1lbnQsIHJlZjtcbiAgY2FsY3VsYXRlZFBhdGggPSBzcGxpdHRlZFBhdGguc2xpY2UoMCwgaW5kZXggKyAxKS5qb2luKFwiL1wiKTtcbiAgcmVmID0gZ2V0RWxlbWVudEZyb21UcmVlKHRyZWUsIGNhbGN1bGF0ZWRQYXRoLCB0cnVlLCBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogc3BsaXR0ZWRQYXRoW2luZGV4XSxcbiAgICAgIGZvbGRlcnM6IFtdLFxuICAgICAgZmlsZXM6IFtdLFxuICAgICAgcGF0aDogY2FsY3VsYXRlZFBhdGhcbiAgICB9O1xuICB9KSwgZWxlbWVudCA9IHJlZlswXSwgdHJlZSA9IHJlZlsxXTtcbiAgaWYgKHNwbGl0dGVkUGF0aC5sZW5ndGggPT09IGluZGV4ICsgMikge1xuICAgIGVsZW1lbnQuZmlsZXMgPSBhZGRGaWxlVG9UcmVlKGVsZW1lbnQuZmlsZXMsIHBhdGgsIHNwbGl0dGVkUGF0aFtpbmRleCArIDFdKTtcbiAgfSBlbHNlIHtcbiAgICBlbGVtZW50LmZvbGRlcnMgPSBhZGRGb2xkZXJUb1RyZWUoZWxlbWVudC5mb2xkZXJzLCBzcGxpdHRlZFBhdGgsIGluZGV4ICsgMSwgcGF0aCk7XG4gIH1cbiAgcmV0dXJuIHRyZWU7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZGF0YTogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpbGVzVHJlZTogW10sXG4gICAgICBjb2xvcnM6IHt9LFxuICAgICAgZXhwYW5kZWQ6IGZhbHNlLFxuICAgICAgc2F2aW5nOiBmYWxzZSxcbiAgICAgIHNhdmVkU2V0dGluZ3M6IFtdLFxuICAgICAgaXNIb3ZlcmVkOiBmYWxzZVxuICAgIH07XG4gIH0sXG4gIG1ldGhvZHM6IHtcbiAgICBob3ZlcjogZnVuY3Rpb24oZSkge1xuICAgICAgcmV0dXJuIHRoaXMuaXNIb3ZlcmVkID0gdHJ1ZTtcbiAgICB9LFxuICAgIHVuaG92ZXI6IGZ1bmN0aW9uKGUpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzSG92ZXJlZCA9IGZhbHNlO1xuICAgIH0sXG4gICAgYWRkRmlsZTogZnVuY3Rpb24ocGF0aCkge1xuICAgICAgdmFyIHJlc3VsdCwgcm9vdEVsZW1lbnQsIHJvb3ROYW1lLCBzcGxpdHRlZFBhdGg7XG4gICAgICB0aGlzLmxvZyhcImFkZGluZyBcIiArIHBhdGgsIDIpO1xuICAgICAgaWYgKGF0b20uY29uZmlnLmdldChcIm9wZW5lZC1maWxlcy5hc0xpc3RcIikpIHtcbiAgICAgICAgcm9vdEVsZW1lbnQgPSB0aGlzLmZpbGVzVHJlZVswXTtcbiAgICAgICAgaWYgKHJvb3RFbGVtZW50ID09IG51bGwpIHtcbiAgICAgICAgICByb290RWxlbWVudCA9IHtcbiAgICAgICAgICAgIG5hbWU6IFwiT3BlbmVkIGZpbGVzXCIsXG4gICAgICAgICAgICBwYXRoOiBcIlwiLFxuICAgICAgICAgICAgZm9sZGVyczogW10sXG4gICAgICAgICAgICBmaWxlczogW10sXG4gICAgICAgICAgICBpc1Jvb3Q6IHRydWVcbiAgICAgICAgICB9O1xuICAgICAgICAgIHRoaXMuZmlsZXNUcmVlLnB1c2gocm9vdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByb290RWxlbWVudC5maWxlcyA9IGFkZEZpbGVUb1RyZWUocm9vdEVsZW1lbnQuZmlsZXMsIHBhdGgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0ID0gYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKHBhdGgpO1xuICAgICAgICBpZiAoKHJlc3VsdCAhPSBudWxsID8gcmVzdWx0WzBdIDogdm9pZCAwKSAhPSBudWxsKSB7XG4gICAgICAgICAgcm9vdE5hbWUgPSByZXN1bHRbMF0uc3BsaXQoc2VwKS5wb3AoKTtcbiAgICAgICAgICByb290RWxlbWVudCA9IHdoZXJlUGF0aCh0aGlzLmZpbGVzVHJlZSwgcmVzdWx0WzBdKTtcbiAgICAgICAgICBpZiAocm9vdEVsZW1lbnQgPT0gbnVsbCkge1xuICAgICAgICAgICAgcm9vdEVsZW1lbnQgPSB7XG4gICAgICAgICAgICAgIG5hbWU6IHJvb3ROYW1lLFxuICAgICAgICAgICAgICBwYXRoOiByZXN1bHRbMF0sXG4gICAgICAgICAgICAgIGZvbGRlcnM6IFtdLFxuICAgICAgICAgICAgICBmaWxlczogW11cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmZpbGVzVHJlZS5wdXNoKHJvb3RFbGVtZW50KTtcbiAgICAgICAgICAgIHNvcnRCeU5hbWUodGhpcy5maWxlc1RyZWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzcGxpdHRlZFBhdGggPSByZXN1bHRbMV0uc3BsaXQoc2VwKTtcbiAgICAgICAgICBpZiAoc3BsaXR0ZWRQYXRoLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIHJvb3RFbGVtZW50LmZpbGVzID0gYWRkRmlsZVRvVHJlZShyb290RWxlbWVudC5maWxlcywgcGF0aCwgc3BsaXR0ZWRQYXRoWzBdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHJvb3RFbGVtZW50LmZvbGRlcnMgPSBhZGRGb2xkZXJUb1RyZWUocm9vdEVsZW1lbnQuZm9sZGVycywgc3BsaXR0ZWRQYXRoLCAwLCBwYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICAgIHNlbGVjdGVkOiBmdW5jdGlvbihwYXRoKSB7XG4gICAgICByZXR1cm4gdGhpcy4kYnJvYWRjYXN0KFwic2VsZWN0ZWRcIiwgcGF0aCk7XG4gICAgfSxcbiAgICByZXNpemU6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRyZWVNYW5hZ2VyLmF1dG9IZWlnaHQoKTtcbiAgICB9LFxuICAgIGNvbG9yQ2hhbmdlQ2I6IGZ1bmN0aW9uKHBhdGgsIGNvbG9yKSB7XG4gICAgICBpZiAoKHR5cGVvZiB0aGlzICE9PSBcInVuZGVmaW5lZFwiICYmIHRoaXMgIT09IG51bGwpICYmICh0aGlzLmNvbG9ycyAhPSBudWxsKSkge1xuICAgICAgICB0aGlzLmxvZyhcImNvbG9yQ2hhbmdlQ2IgY2FsbGVkXCIsIDIpO1xuICAgICAgICB0aGlzLmNvbG9yc1twYXRoXSA9IGNvbG9yO1xuICAgICAgICByZXR1cm4gdGhpcy4kYnJvYWRjYXN0KFwiY29sb3JcIiwgcGF0aCk7XG4gICAgICB9XG4gICAgfSxcbiAgICByZWRyYXc6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGosIGxlbiwgcGF0aCwgcmVzdWx0cztcbiAgICAgIHRoaXMuZmlsZXNUcmVlID0gW107XG4gICAgICByZXN1bHRzID0gW107XG4gICAgICBmb3IgKGogPSAwLCBsZW4gPSBzZXR0aW5ncy5sZW5ndGg7IGogPCBsZW47IGorKykge1xuICAgICAgICBwYXRoID0gc2V0dGluZ3Nbal07XG4gICAgICAgIHJlc3VsdHMucHVzaCh0aGlzLmFkZEZpbGUocGF0aCkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSxcbiAgICByZW1vdmVQYXRoOiBmdW5jdGlvbihwYXRoKSB7XG4gICAgICB2YXIgaTtcbiAgICAgIGkgPSBzZXR0aW5ncy5pbmRleE9mKHBhdGgpO1xuICAgICAgaWYgKGkgPiAtMSkge1xuICAgICAgICByZXR1cm4gc2V0dGluZ3Muc3BsaWNlKGksIDEpO1xuICAgICAgfVxuICAgIH0sXG4gICAgc2F2ZTogZnVuY3Rpb24oKSB7XG4gICAgICBpZiAodGhpcy5zYXZpbmcgPT09IGZhbHNlKSB7XG4gICAgICAgIHRoaXMuc2F2aW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5sb2coXCJzYXZpbmdcIiwgMik7XG4gICAgICAgIHByb2plY3RNYW5hZ2VyLmFkZFRvUHJvamVjdFNldHRpbmcoc2V0dGluZ3MpO1xuICAgICAgICB0aGlzLnNhdmVkU2V0dGluZ3MgPSBzZXR0aW5ncy5zbGljZSgpO1xuICAgICAgICByZXR1cm4gdGhpcy5zYXZpbmcgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubG9nKFwiZGVsYXlpbmcgc2F2ZVwiLCAyKTtcbiAgICAgICAgc2V0VGltZW91dCgoKGZ1bmN0aW9uKF90aGlzKSB7XG4gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIF90aGlzLnNhdmluZyA9IGZhbHNlO1xuICAgICAgICAgIH07XG4gICAgICAgIH0pKHRoaXMpKSwgOTApO1xuICAgICAgICByZXR1cm4gc2V0VGltZW91dCh0aGlzLnNhdmUsIDEwMCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBjbG9zZVVuc2F2ZWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGosIGxlbiwgcGF0aCwgcmVzdWx0cztcbiAgICAgIHJlc3VsdHMgPSBbXTtcbiAgICAgIGZvciAoaiA9IDAsIGxlbiA9IHNldHRpbmdzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7XG4gICAgICAgIHBhdGggPSBzZXR0aW5nc1tqXTtcbiAgICAgICAgaWYgKHRoaXMuc2F2ZWRTZXR0aW5ncy5pbmRleE9mKHBhdGgpID09PSAtMSkge1xuICAgICAgICAgIHJlc3VsdHMucHVzaCh0aGlzLiRicm9hZGNhc3QoXCJjbG9zZVwiLCBwYXRoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0cy5wdXNoKHZvaWQgMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRzO1xuICAgIH1cbiAgfSxcbiAgYmVmb3JlQ29tcGlsZTogZnVuY3Rpb24oKSB7XG4gICAgc2VwID0gcmVxdWlyZShcInBhdGhcIikuc2VwO1xuICAgIGlmIChwcm9qZWN0TWFuYWdlciA9PSBudWxsKSB7XG4gICAgICBwcm9qZWN0TWFuYWdlciA9IHJlcXVpcmUoXCIuLy4uL2xpYi9wcm9qZWN0LW1hbmFnZXJcIik7XG4gICAgfVxuICAgIGlmICh0cmVlTWFuYWdlciA9PSBudWxsKSB7XG4gICAgICB0cmVlTWFuYWdlciA9IHJlcXVpcmUoXCIuLy4uL2xpYi90cmVlLW1hbmFnZXJcIik7XG4gICAgfVxuICAgIHNldHRpbmdzID0gcHJvamVjdE1hbmFnZXIuZ2V0UHJvamVjdFNldHRpbmcoKTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoc2V0dGluZ3MpKSB7XG4gICAgICBzZXR0aW5ncyA9IFtdO1xuICAgIH1cbiAgICB0aGlzLnNhdmVkU2V0dGluZ3MgPSBzZXR0aW5ncy5zbGljZSgpO1xuICAgIHJldHVybiB0aGlzLmxvZyhcImJlZm9yZUNvbXBpbGVcIiwgMik7XG4gIH0sXG4gIGNyZWF0ZWQ6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLiRvbihcInJlbW92ZUZvbGRlclwiLCAoZnVuY3Rpb24oX3RoaXMpIHtcbiAgICAgIHJldHVybiBmdW5jdGlvbihlbnRyeSkge1xuICAgICAgICBfdGhpcy5maWxlc1RyZWUuJHJlbW92ZShlbnRyeSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH07XG4gICAgfSkodGhpcykpO1xuICB9LFxuICBjb21waWxlZDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIGosIGxlbiwgcGF0aDtcbiAgICBmb3IgKGogPSAwLCBsZW4gPSBzZXR0aW5ncy5sZW5ndGg7IGogPCBsZW47IGorKykge1xuICAgICAgcGF0aCA9IHNldHRpbmdzW2pdO1xuICAgICAgdGhpcy5hZGRGaWxlKHBhdGgpO1xuICAgIH1cbiAgICB0aGlzLmFkZERpc3Bvc2FibGUoYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChmdW5jdGlvbihfdGhpcykge1xuICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVkaXRvcikge1xuICAgICAgICBpZiAoKGVkaXRvciAhPSBudWxsID8gZWRpdG9yLmdldFBhdGggOiB2b2lkIDApICE9IG51bGwpIHtcbiAgICAgICAgICBwYXRoID0gZWRpdG9yLmdldFBhdGgoKTtcbiAgICAgICAgICBpZiAoKHBhdGggIT0gbnVsbCkgJiYgc2V0dGluZ3MuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIF90aGlzLmFkZEZpbGUocGF0aCk7XG4gICAgICAgICAgICByZXR1cm4gc2V0dGluZ3MucHVzaChwYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSkodGhpcykpKTtcbiAgICB0aGlzLmFkZERpc3Bvc2FibGUoYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xuICAgICAgJ29wZW5lZC1maWxlczpjbG9zZS1hbGwtYnV0LXNhdmVkJzogdGhpcy5jbG9zZVVuc2F2ZWRcbiAgICB9KSk7XG4gICAgdGhpcy5hZGREaXNwb3NhYmxlKGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlKCdvcGVuZWQtZmlsZXMuYXNMaXN0JywgdGhpcy5yZWRyYXcpKTtcbiAgICB0aGlzLmFkZERpc3Bvc2FibGUoYXRvbS5jb25maWcub25EaWRDaGFuZ2UoJ29wZW5lZC1maWxlcy5oaWdobGlnaHRPbkhvdmVyJywgdGhpcy5yZWRyYXcpKTtcbiAgICB0aGlzLmFkZERpc3Bvc2FibGUoYXRvbS5jb25maWcub25EaWRDaGFuZ2UoJ29wZW5lZC1maWxlcy5kZWJ1ZycsIHRoaXMucmVkcmF3KSk7XG4gICAgcmV0dXJuIHRoaXMubG9nKFwiY29tcGlsZWRcIiwgMik7XG4gIH0sXG4gIHJlYWR5OiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5sb2coXCJyZWFkeVwiLCAyKTtcbiAgfSxcbiAgYXR0YWNoZWQ6IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmxvZyhcImF0dGFjaGVkXCIsIDIpO1xuICB9XG59O1xuXG47KHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gXCJmdW5jdGlvblwiPyBtb2R1bGUuZXhwb3J0cy5vcHRpb25zOiBtb2R1bGUuZXhwb3J0cykudGVtcGxhdGUgPSBfX3Z1ZV90ZW1wbGF0ZV9fO1xuIl19